var interval_pingsong;
 var current_song_time_left;

window.ws.onmessage = function(message) {
  var content, current_user, data, sender_email;
  console.log("received: ", message);
  data = JSON.parse(message.data);
  current_user = $('.currentuser').text();
  content = data.content.split("TKOJ")[1];
  sender_email = data.content.split("TKOJ")[0];
  if (sender_email !== current_user) {
    console.log(content = content.replace('ChatLog__entry ChatLog__entry_mine', 'ChatLog__entry'));
  }
  var $chatWrapper = $('.chat-wrapper');
  var $messages = $('.messages');
  switch (data.event) {
    case 'message_create':
    $(content).appendTo('.messages');
    $('.chat-wrapper').scrollTop($('.messages').height()+1000);

            //$('.chat-wrapper').find('messages').scrollTop($messages.scrollHeight);

            return '';
            case 'message_delete':
            return $('.messages').find(data.content).slideUp(300, function() {
              return $(this).remove();
            });
            default:
            return console.log("unknown event", data.event);
          }
        };

// ---
// generated by coffee-script 1.9.2



function pingsong(duration, display, type, id) {
  id = id.trim();
  clearInterval(interval_pingsong);
  var start = Date.now(),
  diff,
  minutes,
  seconds;
 interval_pingsong = "";
  function timer() {
        // get the number of seconds that have elapsed since 
        // startTimer() was called
        diff = duration - (((Date.now() - start) / 1000) | 0);
        current_song_time_left = current_song_time_left -1;
        // does the same job as parseInt truncates the float
        minutes = (diff / 60) | 0;
        seconds = (diff % 60) | 0;

        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;
        if(type == "conversation")
        {
          display.textContent = minutes + ":" + seconds; 
          if (diff%2 ==0 && diff != 0) {
            
            $.post( "/pingsong_conversation.json?id=" + id, function( data ) {
              if (data.html != "")
              {
                if(data.html.indexOf("join conversation") != -1)
                {
                  if($('.user_join').length <=0)
                  {
                    var user_join = "<center><div class='user_join text-success'>" + data.html + "</div>";

                    $(user_join).appendTo('.messages').slideDown();
                    $('.chat-wrapper').scrollTop($('.messages').height());
                  }                  
                }
                else if($('.user_has_left').length <= 0)
                {
                  var user_has_left = "<center><div class='user_has_left text-danger'><strong>" + data.html +"</strong> has left</div></ center>";

                  $(user_has_left).appendTo('.messages').slideDown();
                  $('.chat-wrapper').scrollTop($('.messages').height());
                }                
              }
            });

            $.post( "/get_new_song.json?id=" + id, function( data ) {
              if (data.html != "")
              {
                    for (i = 0; i < data.html.length; i++) { 
                        var minutes = ~~(data.html[i].length/60)
                        var seconds = data.html[i].length %60
                        var newsong = "<li class='next-song'><div class='next-song-time'> " +minutes + ":" + seconds + "</div> <div class='next-song-name'> - " +  data.html[i].name + " </div><div class='next-song-id'>"+ data.html[i].utubeid + "</div></li>";
                        var current_time_left = $("#timeleft").text();
                        var total_second_left = parseInt(current_time_left.split(':')[0]) *60 + parseInt(current_time_left.split(':')[1]);
                        total_second_left = total_second_left + parseInt(data.html[i].length);
                        display = document.querySelector('#timeleft');
                        var converid = $("#current_song").text();

                        pingsong(total_second_left, display, "conversation", converid);

                        $(newsong).appendTo('.songlist');

                         var current_time_left = $("#timeleft").text();
                          var total_second_left = parseInt(current_time_left.split(':')[0]) *60 + parseInt(current_time_left.split(':')[1]);
                          total_second_left = total_second_left + parseInt(data.html[i].length);
                          display = document.querySelector('#timeleft');
                          var converid = $("#current_song").text();

                          pingsong(total_second_left, display, "conversation", converid);
                        
                    }
              }
            });

            
          }    
          if (minutes == 00 && seconds ==15){
            var time_say_bye = "<center><div style='max-width: 300px' class='time_say_bye text-danger text-inline'>15s left, time to say goobye forever'</div></center>"
             $(time_say_bye).appendTo('.messages').slideDown();
                $('.chat-wrapper').scrollTop($('.messages').height());
          }
          if (current_song_time_left <=0) 
          {
            playlist = $('.next-song');
            if(playlist.length >0)
            {
              $('.next-song').eq(0).slideUp();
              $('.next-song').eq(0).remove();
               current_time_left = $("#timeleft").text();
               next_song_time = $('.next-song-time').eq(0).text().trim();
              current_song_time_left = parseInt(next_song_time.split(':')[0]) *60 + parseInt(next_song_time.split(':')[1]);
              next_song_utubeid = $('.next-song-id').eq(0).text();
              document.getElementById('iframe_video').src = "http://www.youtube.com/embed/" + next_song_utubeid + "?autoplay=1&cc_load_policy=1&fs=0";              
              $('.next-song').eq(0).addClass("text-success")
              
            }

          }
          if (diff <= 0) {
            // add one second so that the count down starts at the full duration
            // example 05:00 not 04:59
            // start = Date.now() + 1000;
            display.textContent = "00:00"; 
            $(".time_say_bye").remove();
            $('#new_message').hide();
            if($('.conversation_over').length <= 0)
            {
              var conversation_over = "<center><div class='conversation_over text-info'>End</div></ center>";
              $(conversation_over).appendTo('.messages').slideDown();
              $('.chat-wrapper').scrollTop($('.messages').height());
            }
            clearInterval(interval_pingsong);
          }
        }
        else if(type == "song")
        {
          if (diff%2 ==0 && diff != 0 ) 
          {
           $.post( "/pingsong.json?id=" + id, function( data ) {
            if (data.html != "" && !$("#conversation-modal").is(':visible'))
            {

              var go_Conversation = document.getElementById("go_conversation");
              go_Conversation.setAttribute("href", "/conversations/" + data.html);

                    //  var go_Conversation = document.getElementById("cancel_conversation");
                    // go_Conversation.setAttribute("href", ".conversations/cancel");
                    $("#conversation-modal").modal({show: true});
                  }
                });
            }
            if(diff <=0)
            {
              clearInterval(interval_pingsong);
            }
          }
        };
    // we don't want to wait a full second before the timer starts
    
    window.onbeforeunload = function() {
      console.log('window.onbeforeunload');
      clearInterval(interval_pingsong);
    }
    $(document).on('page:before-unload', function(event) {
      //alert('hello turbolink');
      console.log('page:before-unload');
      clearInterval(interval_pingsong);
    });
    interval_pingsong = setInterval(timer, 1000);
    

  }


  window.onload = function () {
    $("#go_conversation").click(function(){
        
    });

  };

